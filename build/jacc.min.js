/*! jacc 2014-02-17 */
(function(){var a;a=null!=a?a:this,a.create=function(){return{_commands:"[add|delete|list|update|status|help]",_dockerConnOptions:{socketPath:!1,host:"http://localhost",port:"4243",version:"v1.1"},async:require("async"),redis:require("redis"),_isset:function(a,b,c){if(null==a){if(console.log(b),void 0!==c&&c)return!1;process.exit()}return!0},_f:function(a,b,c,d){if(b)throw b;return null!==d&&d(c),a.quit()},_redis:function(a,b,c){var d,e=this;if(!b instanceof Array)throw new Error("_redis: argument not an array");return d=this.redis.createClient(),d.on("connect",function(){switch(a){case"keys":return d.keys(b[0],function(a,b){return e._f(d,a,b,c)});case"get":return d.get(b[0],function(a,b){return e._f(d,a,b,c)});case"del":return d.del(b[0],function(a,b){return e._f(d,a,b,c)});case"rpush":return d.rpush(b[0],b[1],function(a,b){return e._f(d,a,b,c)});case"set":return d.set(b[0],b[1],function(a,b){return e._f(d,a,b,c)});case"smembers":return d.smembers(b[0],function(a,b){return e._f(d,a,b,c)});case"sadd":return d.sadd(b[0],b[1],function(a,b){return e._f(d,a,b,c)});case"lrange":return d.lrange(b[0],b[1],b[2],function(a,b){return e._f(d,a,b,c)});default:throw Error("_redis: unsuported operation")}})},_onJaccConfig:function(a,b){var c=this;return this._redis("smembers",["images"],function(d){return 0===d.length?console.log("EMPTY JACC CONFIG!"):c.async.each(d,function(b,c){return null!=b?a(b,c):void 0},function(){return null!=b?b():void 0})})},_onContainers:function(a,b){var c,d,e=this;return d={},this._containers={},c=require("docker.io")(this._dockerConnOptions),c.containers.list(d,function(f,g){if(f)throw null!=b&&b(),f;if(0===g.length){if(null!=b)return b()}else if(e.async.each(g,function(b,e){return d={},c.containers.inspect(b.Id,d,function(b,c){if(b)throw b;return a(c),e()})},function(){return null!=b?b():void 0}),null!=b)return b()})},_listImages:function(a){var b=this;return this._runningImages={},this._onContainers(function(a){return void 0===b._runningImages[a.Image.slice(0,12)]&&(b._runningImages[a.Image.slice(0,12)]=[]),b._runningImages[a.Image.slice(0,12)].push({ID:a.ID.slice(0,12),IP:a.NetworkSettings.IPAddress})},a)},_buildHipacheConfig:function(a){var b=this;return this._onJaccConfig(function(a,c){return b._redis("get",[a],function(d){var e,f,g,h;return h=JSON.parse(d),f=h.URL,g=h.internal_port,e=h.DNS,null==b._runningImages[a]?(console.log("Image "+a+" lacks running containers"),c()):b._redis("set",[e,b._runningImages[a][0].IP],function(){var d;return d="frontend:"+f,b._redis("del",[d],function(){return b._redis("rpush",[d,a],function(){return b.async.each(b._runningImages[a],function(a,c){return b._redis("rpush",[d,"http://"+a.IP+":"+g],c)},c)})})})})},a)},update:function(){var a=this;return this._listImages(function(){return a._buildHipacheConfig()})},list:function(){var a=this;return console.log("Jacc: current configuration"),this._onJaccConfig(function(b,c){return a._redis("get",[b],function(a){return console.log(JSON.stringify(b)+" - "+JSON.stringify(a)),c()})},null)},status:function(a){return console.log("Jacc: List of running containers"),this._onContainers(function(a){return console.log("container:"+a.ID.slice(0,13)+" image:"+a.Image.slice(0,13)+" IP:"+a.NetworkSettings.IPAddress)},a)},add:function(a,b,c,d,e){var f=this;return console.log("Jacc: adding "+a+" - remeber to do 'jacc update'"),this._redis("sadd",["images",a],function(){var g;return g=[a,JSON.stringify({URL:b,internal_port:c,DNS:d})],f._redis("set",g,function(){return null!=e?e():void 0})})},"delete":function(a){var b;return console.log("Jacc: deleting "+a),b=this.redis.createClient(),b.on("connect",function(){return b.srem("images",a,function(a,c){return console.log("result - "+c),b.quit()})})},main:function(){var a;switch(a=require("optimist").usage("Usage: $0 "+this._commands).argv,this._isset(a._,"jacc requires a command - node app.js "+this._commands),a._[0]){case"add":return this.add(a._[1],a._[2],a._[3],a._[4]);case"delete":return this["delete"](a._[1]);case"update":return this.update();case"status":return this.status();case"list":return this.list();case"help":return console.log("usage: jacc "+this._commands),console.log("jacc add image URL port dns-name (exmaple: jacc add 123456789 www.example.com 80 example.local)"),console.log("jacc delete image"),console.log("jacc update"),console.log("jacc list"),console.log("jacc status"),console.log("help: show this message");default:return console.log("No such command: "+a._[0])}}}}}).call(this);